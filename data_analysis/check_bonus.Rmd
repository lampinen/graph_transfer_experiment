---
title: "Bonus checks"
output: html_document
---

# libraries

```{r}
library(rjson)
library(purrr)
library(tidyverse)
```

# Load data

```{r}
data_dir = "../raw_data/ex0"
cosub_parent_dir = "../mturk/ex0"
data_files = list.files(data_dir)

df.graph_trials = data.frame()

graph_trials_to_df = function(list_data) {
  df = tibble::as_tibble(list_data[c("trial_type", "trial_index", "graph_trial_type", "trajectory", "keypresses", "keypress_rts", "keyups", "keyup_rts")])
  df$nodes_to_keys = rep(list(list_data$nodes_to_keys), nrow(df))
  return(df)
}

for (filename in data_files) {
  list.this_subject_data = fromJSON(file=sprintf("%s/%s", data_dir, filename)) 
  df.this_subject_data = graph_trials_to_df(list.this_subject_data[[5]]) %>%
    bind_rows(graph_trials_to_df(list.this_subject_data[[7]]))
  df.this_subject_data$subject_id = str_split(filename, '\\.', simplify=T)[1, 1] 
  df.graph_trials = bind_rows(df.graph_trials, df.this_subject_data)
}
```

```{r}
df.graph_trials = df.graph_trials %>%
  rowwise() %>%
  mutate(target = ifelse(graph_trial_type == 'letter', 
                         list(nodes_to_keys[[trajectory+1]]),
                         list(nodes_to_keys[[trajectory+1]]))) %>%
  ungroup() %>%
  mutate(correct = map_int(keypresses, length) == map_int(target, length))
```

# assess performance by subject

```{r}
df.bonuses = df.graph_trials %>%
  group_by(subject_id) %>%
  summarize(pct_correct = mean(correct)) %>%
  mutate(bonus = pct_correct >= 0.9) %>%
  separate(subject_id, c("subject_id", "submission_time"))

```

```{r}
df.assignments = tibble()
for (res_file in Sys.glob(paste(cosub_parent_dir, '/*/production-results/*.json', sep=""))) {
  assignment_id = res_file %>%
    basename() %>%
    str_sub(0, -6) # remove .json
  this_result = RJSONIO::fromJSON(res_file) # for some reason rjson seems to have a bug???
  df.assignments = bind_rows(df.assignments,
                             tibble(subject_id=this_result$WorkerId, 
                                    assignment_id=assignment_id))
}
```

```{r}
df.bonuses = left_join(df.bonuses, df.assignments)
df.bonuses
```

